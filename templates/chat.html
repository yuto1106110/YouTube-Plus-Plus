<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Plus Chat</title>
    <style>
        :root { --bg-color: #0f0f0f; --container-bg: #1e1e1e; --text-color: #ffffff; --accent-color: #3ea6ff; --input-bg: #2a2a2a; --border-color: #444; --msg-bg: #333333; --me-msg-bg: #263850; }
        
        .badge { font-size: 9px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; vertical-align: middle; font-weight: bold; text-transform: uppercase; display: inline-block; }
        .badge-OWNER { background: #ff4e4e; color: white; box-shadow: 0 0 5px rgba(255, 78, 78, 0.5); }
        .badge-ADMIN { background: #ffa500; color: black; }
        .badge-USER { display: none; }

        body, html { margin: 0; padding: 0; width: 100%; height: 100dvh; background-color: var(--bg-color); overflow: hidden; font-family: sans-serif; color: white; }
        #app { width: 100%; height: 100dvh; display: flex; flex-direction: column; position: relative; }
        .hidden { display: none !important; }

        /* 返信表示のスタイル */
        .reply-box { background: rgba(0,0,0,0.3); border-left: 3px solid var(--accent-color); padding: 5px 10px; margin-bottom: 8px; font-size: 12px; color: #bbb; border-radius: 4px; cursor: pointer; }
        .reply-preview { position: absolute; bottom: 80px; left: 0; width: 100%; background: #252525; padding: 10px 15px; border-top: 2px solid var(--accent-color); display: flex; justify-content: space-between; align-items: center; z-index: 50; box-sizing: border-box; }
        .edited-tag { font-size: 10px; color: #888; margin-left: 5px; font-style: italic; }

        .auth-page { flex: 1; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .auth-card { width: 100%; max-width: 360px; background-color: var(--container-bg); padding: 30px; border-radius: 12px; border: 1px solid var(--border-color); }
        .auth-card input { width: 100%; padding: 12px; margin-bottom: 15px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: white; box-sizing: border-box; }
        .auth-btn { width: 100%; padding: 12px; background: var(--accent-color); color: #000; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }

        .header { padding: 10px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: #252525; z-index: 10; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; list-style: none; margin: 0; }
        .message-item { background: var(--msg-bg); padding: 10px 14px; border-radius: 12px; border: 1px solid var(--border-color); max-width: 85%; position: relative; word-break: break-all; }
        .me { align-self: flex-end; background: var(--me-msg-bg); border-left: 4px solid var(--accent-color); }
        .user-name { font-size: 11px; font-weight: bold; margin-bottom: 4px; display: flex; align-items: center; cursor: pointer; }
        
        .input-area { padding: 15px; border-top: 1px solid var(--border-color); background: var(--container-bg); display: flex; gap: 10px; position: relative; padding-bottom: calc(15px + env(safe-area-inset-bottom)); }
        .chat-input { flex: 1; padding: 12px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 24px; color: white; outline: none; font-size: 16px; }

        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:90; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #222; padding: 25px; border-radius: 15px; border: 1px solid var(--accent-color); z-index: 100; width: 85%; max-width: 320px; text-align: center; }
        .btn-m { width: 100%; padding: 10px; margin-top: 8px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; background: #444; color: white; }
        .btn-s { padding: 5px; font-size: 10px; background: #333; color: #ccc; border: 1px solid #555; border-radius: 4px; cursor: pointer; }
        .mute-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; margin-top: 10px; }
        .status-box { background: #111; padding: 8px; border-radius: 6px; font-size: 11px; margin: 10px 0; text-align: left; line-height: 1.6; border: 1px solid #333; }
        
        #scroll-btn { position: absolute; bottom: 100px; right: 20px; background: var(--accent-color); border: none; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; display: none; font-size: 20px; z-index: 20; color: #000; }
    </style>
</head>
<body>

<div id="app">
    <div id="auth-page" class="auth-page">
        <div class="auth-card">
            <h2 id="auth-title">ログイン</h2>
            <input type="text" id="auth-user" placeholder="名前" maxlength="15">
            <input type="password" id="auth-pass" placeholder="パスワード">
            <button class="auth-btn" onclick="handleAuth()" id="auth-btn-text">ログイン</button>
            <p style="text-align:center; margin-top:15px; font-size: 14px;">
                <span style="color:var(--accent-color); cursor:pointer; font-weight:bold;" onclick="toggleAuth()" id="toggle-text">新規登録はこちら</span>
            </p>
        </div>
    </div>

    <div id="chat-page" class="hidden" style="display:flex; flex-direction:column; height:100%;">
        <div class="header">
            <div style="display:flex; align-items:center; gap:10px;">
                <span onclick="openSettings()" style="cursor:pointer; font-size:18px;">⚙️</span>
                <span id="my-display-name" style="font-weight:bold;"></span>
                <span id="online-count" style="font-size:12px; color:#aaa; background:#111; padding:2px 8px; border-radius:10px;">0 Online</span>
            </div>
            <button onclick="logout()" style="background:none; border:1px solid #555; color:#ccc; padding:4px 8px; border-radius:4px; font-size:12px;">ログアウト</button>
        </div>
        
        <ul id="messages" onscroll="handleScroll()"></ul>
        <button id="scroll-btn" onclick="scrollToBottom()">↓</button>

        <div id="reply-preview" class="reply-preview hidden">
            <div id="reply-info" style="font-size:12px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; flex:1;"></div>
            <span onclick="cancelReply()" style="cursor:pointer; padding:5px; margin-left:10px; font-weight:bold;">✕</span>
        </div>

        <div class="input-area">
            <input type="text" id="msg-input" class="chat-input" placeholder="メッセージを入力..." maxlength="300" onkeypress="if(event.key==='Enter') send()">
        </div>
    </div>

    <div id="modal-area" class="hidden">
        <div class="overlay" onclick="closeModal()"></div>
        <div id="modal-content" class="modal"></div>
    </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
    const SERVER = "https://plus-chat-api.onrender.com";
    const ROLES = { OWNER: 100, ADMIN: 50, USER: 0 };
    let socket, myName, myId, myRole, myColor, mode = 'login', isAutoScroll = true, isCoolingDown = false, currentReply = null;

    window.onload = () => {
        const u = localStorage.getItem('plus_chat_user'), p = localStorage.getItem('plus_chat_pass');
        if (u && p) { document.getElementById('auth-user').value = u; document.getElementById('auth-pass').value = p; handleAuth(true); }
    };

    function toggleAuth() {
        mode = (mode === 'login' ? 'register' : 'login');
        document.getElementById('auth-title').innerText = mode === 'login' ? 'ログイン' : '新規登録';
        document.getElementById('auth-btn-text').innerText = mode === 'login' ? 'ログイン' : '登録する';
        document.getElementById('toggle-text').innerText = mode === 'login' ? '新規登録はこちら' : 'ログインに戻る';
    }

    async function handleAuth(isAuto = false) {
        const u = document.getElementById('auth-user').value.trim(), p = document.getElementById('auth-pass').value;
        if(!u || !p) return;
        try {
            const res = await fetch(`${SERVER}/api/${mode}`, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ username: u, password: p }) 
            });
            const data = await res.json();
            if (data.success) {
                if (mode === 'login') {
                    localStorage.setItem('plus_chat_user', u);
                    localStorage.setItem('plus_chat_pass', p);
                    myName = data.username; myId = data.userId; myRole = data.role; myColor = data.nameColor;
                    startChat();
                } else { alert("登録完了。ログインしてください。"); toggleAuth(); }
            } else { if(!isAuto) alert(data.message); else logout(); }
        } catch(e) { if(!isAuto) alert("接続エラー"); }
    }

    function startChat() {
        document.getElementById('auth-page').classList.add('hidden');
        document.getElementById('chat-page').classList.remove('hidden');
        document.getElementById('my-display-name').innerText = myName;
        
        socket = io(SERVER);
        
        socket.on('load messages', msgs => { 
            const l = document.getElementById('messages'); 
            l.innerHTML = ''; 
            msgs.forEach(addMsg); 
            scrollToBottom(); 
        });

        socket.on('chat message', d => { 
            addMsg(d); 
            if (isAutoScroll) scrollToBottom(); 
        });

        // 編集・更新の受信
        socket.on('update message', d => {
            const el = document.querySelector(`#msg-${d.id} .msg-text-body`);
            if(el) { 
                el.innerText = d.text;
                if(!el.parentElement.querySelector('.edited-tag')) {
                    const tag = document.createElement('span');
                    tag.className = 'edited-tag';
                    tag.innerText = '(編集済)';
                    el.parentElement.appendChild(tag);
                }
            }
        });

        socket.on('online count', c => document.getElementById('online-count').innerText = c + ' Online');
        socket.on('delete message', id => document.getElementById(`msg-${id}`)?.remove());
        socket.on('force logout', () => location.reload());
        
        socket.on('user status data', d => {
            const b = document.getElementById('status-box');
            if(!b) return;
            let statusHtml = `状態: ${d.isBanned ? '<span style="color:red">BAN</span>' : '正常'}<br>`;
            // 管理者以上の場合のみ隠密状態を表示
            if (ROLES[myRole] >= ROLES.ADMIN) {
                statusHtml += `隠密: ${d.isShadowBanned ? 'ON' : 'OFF'}<br>`;
            }
            statusHtml += `ミュート: <span style="color:#ff4e4e">${d.muteStatus}</span>`;
            b.innerHTML = statusHtml;
        });
    }

    function addMsg(d) {
        const li = document.createElement('li');
        li.className = 'message-item' + (d.userId === myId ? ' me' : '');
        li.id = `msg-${d.id}`;
        
        // 返信データの構築
        let replyHtml = d.replyTo ? `<div class="reply-box" onclick="scrollToMsg(${d.replyTo.id})">@${d.replyTo.user}: ${d.replyTo.text}</div>` : '';
        let editedHtml = d.isEdited ? `<span class="edited-tag">(編集済)</span>` : '';

        li.innerHTML = `
            ${replyHtml}
            <span class="user-name" onclick="openUserMenu('${d.user}', '${d.userId}', '${d.role}', ${d.id}, '${d.text.replace(/'/g,"\\'")}')">
                <span style="color:${d.color || '#3ea6ff'}">${d.user}</span>
                <span class="badge badge-${d.role}">${d.role}</span>
            </span>
            <div style="font-size:15px; color:#eee; margin-top:4px;">
                <span class="msg-text-body">${d.text}</span>${editedHtml}
            </div>
            <span style="font-size:10px; color:#888; float:right; margin-top:4px;">${new Date(d.id).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>
            <div style="clear:both;"></div>
        `;
        document.getElementById('messages').appendChild(li);
    }

    function openUserMenu(name, tid, trole, mid, text) {
        const content = document.getElementById('modal-content');
        content.innerHTML = `<h3>${name}</h3><div id="status-box" class="status-box">取得中...</div>`;
        socket.emit('get user status', tid);

        // 共通アクション
        content.innerHTML += `<button class="btn-m" style="background:var(--accent-color); color:#000;" onclick="setReply(${mid}, '${name}', '${text}')">返信する</button>`;
        content.innerHTML += `<button class="btn-m" onclick="navigator.clipboard.writeText('${tid}');alert('IDコピー完了')">IDコピー</button>`;
        
        // 自分のメッセージ管理
        if (tid === myId) {
            content.innerHTML += `<button class="btn-m" style="background:#ffa500; color:#000;" onclick="editMyMsg(${mid}, '${text}')">編集する</button>`;
            content.innerHTML += `<button class="btn-m" style="background:#ff4e4e;" onclick="deleteMyMsg(${mid})">削除する</button>`;
        }

        // 管理権限
        if (ROLES[myRole] >= ROLES.ADMIN && myId !== tid) {
            content.innerHTML += `<button class="btn-m" onclick="doAdmin('delete','${tid}',null,${mid})">管理者削除</button>
            <div style="margin-top:10px; border:1px solid #444; padding:10px; border-radius:12px; background:#1a1a1a;">
                <p style="font-size:11px; margin-bottom:5px; color:var(--accent-color); font-weight:bold;">ミュート管理</p>
                <div class="mute-grid">
                    <button class="btn-s" onclick="doMute('${tid}',10)">10分</button>
                    <button class="btn-s" onclick="doMute('${tid}',60)">1時間</button>
                    <button class="btn-s" onclick="doMute('${tid}',1440)">1日</button>
                    <button class="btn-s" style="color:#ff4e4e" onclick="doMute('${tid}',null)">永久</button>
                </div>
                <button class="btn-m" style="background:#28a745; margin-top:8px;" onclick="doAdmin('unmute','${tid}')">ミュート解除</button>
            </div>
            <button class="btn-m" style="background:#673ab7;" onclick="doAdmin('shadowban','${tid}')">隠密適用</button>
            <button class="btn-m" onclick="doAdmin('unshadowban','${tid}')">隠密解除</button>`;
        }
        
        if (myRole === 'OWNER' && myId !== tid) {
            content.innerHTML += `<hr style="border:0.5px solid #444; margin:10px 0;">`;
            content.innerHTML += trole === 'USER' ? `<button class="btn-m" style="background:#ffa500; color:#000;" onclick="doAdmin('promote','${tid}')">ADMIN任命</button>` : `<button class="btn-m" onclick="doAdmin('demote','${tid}')">権限剥奪</button>`;
            content.innerHTML += `<button class="btn-m" style="background:#cc0000;" onclick="doAdmin('ban','${tid}')">永久BAN</button>`;
        }

        content.innerHTML += `<button class="btn-m" style="background:none; color:#888;" onclick="closeModal()">閉じる</button>`;
        document.getElementById('modal-area').classList.remove('hidden');
    }

    // 返信機能のロジック
    function setReply(mid, name, text) {
        currentReply = { id: mid, user: name, text: text };
        document.getElementById('reply-info').innerText = `@${name}: ${text}`;
        document.getElementById('reply-preview').classList.remove('hidden');
        closeModal();
        document.getElementById('msg-input').focus();
    }

    function cancelReply() {
        currentReply = null;
        document.getElementById('reply-preview').classList.add('hidden');
    }

    function scrollToMsg(id) {
        const el = document.getElementById(`msg-${id}`);
        if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // 自分のメッセージ編集・削除
    function editMyMsg(mid, oldText) {
        const newText = prompt("メッセージを編集してください:", oldText);
        if (newText !== null && newText.trim() !== "" && newText !== oldText) {
            socket.emit('edit message', { myId, msgId: mid, newText: newText.trim() });
        }
        closeModal();
    }

    function deleteMyMsg(mid) {
        if (confirm("自分のメッセージを削除しますか？")) {
            socket.emit('delete my message', { myId, msgId: mid });
        }
        closeModal();
    }

    function openSettings() {
        const content = document.getElementById('modal-content');
        content.innerHTML = `<h3>設定</h3>
            <p style="font-size:13px; color:#ccc;">名前の色を選択</p>
            <input type="color" id="color-picker" value="${myColor || '#3ea6ff'}" style="width:100%; height:50px; border:2px solid #444; background:none; border-radius:8px; cursor:pointer;">
            <button class="btn-m" style="background:var(--accent-color); color:#000;" onclick="saveColor()">保存</button>
            <button class="btn-m" style="background:none; color:#888;" onclick="closeModal()">閉じる</button>`;
        document.getElementById('modal-area').classList.remove('hidden');
    }

    function saveColor() {
        myColor = document.getElementById('color-picker').value;
        socket.emit('update color', { userId: myId, color: myColor });
        alert("名前の色を更新しました。");
        closeModal();
    }

    function send() {
        if (isCoolingDown) return;
        const i = document.getElementById('msg-input');
        const text = i.value.trim();
        if(text){ 
            isCoolingDown = true;
            socket.emit('chat message', { userId: myId, text: text, replyTo: currentReply }); 
            i.value = ''; 
            cancelReply();
            setTimeout(() => { isCoolingDown = false; }, 3000);
        }
    }

    function handleScroll() {
        const l = document.getElementById('messages');
        isAutoScroll = l.scrollHeight - l.scrollTop - l.clientHeight < 100;
        document.getElementById('scroll-btn').style.display = isAutoScroll ? 'none' : 'block';
    }

    function scrollToBottom() { const l = document.getElementById('messages'); l.scrollTop = l.scrollHeight; }
    function doAdmin(type, targetId, role, msgId) { if(confirm("実行しますか？")) socket.emit('admin command', { type, targetId, myId, msgId }); closeModal(); }
    function doMute(targetId, mins) { socket.emit('admin command', { type: 'mute', targetId, myId, minutes: mins }); closeModal(); }
    function closeModal() { document.getElementById('modal-area').classList.add('hidden'); }
    function logout() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>

